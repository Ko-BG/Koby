<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LIPA ‚Ä¢ SME Pan-African Hub 2026</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Mono&display=swap" rel="stylesheet">
<style>
:root {
    --bg:#020617; --card:#0f172a; --text:#f8fafc;
    --accent:#10b981; --crypto:#f59e0b; --vault-color:#8b5cf6;
    --border:#1e293b; --muted:#94a3b8; --danger:#ef4444;
    --incentive:#3b82f6;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);padding:12px;line-height:1.4;}
.container{max-width:1100px;margin:0 auto;padding-bottom:80px;}
.page { display: none; }
.active-page { display: block; }

/* Dashboard UI */
h1{font-size:1.4rem;font-weight:800;letter-spacing:-1px;}
.tagline{font-size:0.8rem;color:var(--muted);margin-bottom:20px;}
.auth-container { max-width: 400px; margin: 60px auto; text-align: center; }
.auth-card { background: var(--card); border: 1px solid var(--border); padding: 30px; border-radius: 28px; }
.card{background:var(--card);border:1px solid var(--border);border-radius:28px;padding:22px;margin-bottom:16px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.3);}
.card-title{font-size:0.7rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;}

.bal-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:15px;}
.bal-item{background:rgba(0,0,0,0.3);padding:15px;border-radius:20px;border:1px solid var(--border);}
.bal-val{font-size:1.6rem;font-weight:800;color:var(--accent);}
.bal-sub{font-family:'Space Mono';font-size:0.85rem;color:var(--crypto);}

/* Analytics Bars */
.analytics-container { display: flex; align-items: flex-end; justify-content: space-around; height: 120px; padding-top: 15px; border-top: 1px solid var(--border); }
.bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; }
.bar { width: 15px; background: var(--accent); border-radius: 4px 4px 0 0; transition: height 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); min-height: 2px; }
.bar.incentive-bar { background: var(--incentive); }
.bar-label { font-size: 0.6rem; font-weight: 800; color: var(--muted); }

/* Buttons & Inputs */
button{width:100%;padding:16px;border:none;border-radius:16px;font-weight:700;cursor:pointer;transition:0.2s;font-size:0.95rem; margin-bottom: 8px;}
button:active{transform:scale(0.98);}
.btn-primary{background:var(--accent);color:#064e3b;}
.btn-vault{background:var(--vault-color);color:white;}
.btn-swap{background:#1e293b;color:var(--crypto);border:1px solid var(--crypto);}
.btn-withdraw{background:#1e293b;color:white;border:1px solid var(--border);}
.btn-logout{background:var(--danger);color:white; font-size: 0.7rem; padding: 8px 12px; width: auto; border-radius: 8px;}
.btn-ghost{background:none; color: var(--accent); text-decoration: underline; font-size: 0.85rem;}
.btn-settle { background: #334155; color: #f1f5f9; border: 1px dashed var(--muted); }

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:1000;padding:15px;backdrop-filter:blur(10px);}
.modal-inner{background:#1e293b;border:1px solid var(--border);width:100%;max-width:400px;padding:25px;border-radius:32px;overflow-y:auto;max-height:90vh;}
label{display:block;font-size:0.7rem;color:var(--muted);margin:12px 0 4px;}
input,select{width:100%;padding:14px;border-radius:12px;border:1px solid var(--border);background:#020617;color:white;font-size:1rem;margin-bottom:10px;}

.tx-item{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #1e293b;font-size:0.85rem;}
.grid{display:grid;gap:16px;}
@media(min-width:768px){.grid{grid-template-columns:1fr 1fr;}}

/* Receipts */
.receipt-box { background: #fff; color: #000; padding: 20px; border-radius: 4px; font-family: 'Space Mono', monospace; font-size: 0.75rem; }
.receipt-header { border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; text-align: center; }
.receipt-line { display: flex; justify-content: space-between; margin: 4px 0; }
.receipt-total { border-top: 1px solid #000; margin-top: 10px; padding-top: 8px; font-weight: 800; font-size: 0.9rem; }

.profile-img { width: 60px; height: 60px; background: var(--accent); border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
</style>
</head>
<body>

<div id="signupPage" class="page active-page">
    <div class="auth-container">
        <h1>LIPA <span style="color:var(--accent)">SME</span></h1>
        <p class="tagline">Pan-African Settlement Hub 2026</p>
        <div class="auth-card">
            <h3>Merchant Onboarding</h3>
            <label>Business Name</label>
            <input type="text" id="regName" placeholder="Zuri Fashions Ltd">
            <label>Settlement Wallet (Till / Phone)</label>
            <input type="text" id="regWallet" placeholder="e.g. 5442211 or 07xx">
            <label>Business Email</label>
            <input type="email" id="regEmail" placeholder="admin@biz.com">
            <label>Create PIN (4 Digits)</label>
            <input type="password" id="regPin" maxlength="4" placeholder="****">
            <button class="btn-primary" onclick="handleSignup()">Link Wallet & Create Account</button>
            <p style="font-size:0.8rem; color:var(--muted)">Already a merchant? <button class="btn-ghost" onclick="navigateTo('loginPage')">Login</button></p>
        </div>
    </div>
</div>

<div id="loginPage" class="page">
    <div class="auth-container">
        <h1>LIPA <span style="color:var(--accent)">ACCESS</span></h1>
        <div class="auth-card">
            <h3>Merchant Login</h3>
            <label>Business Email</label>
            <input id="loginEmail" type="email" placeholder="admin@zuri.africa">
            <label>Access PIN</label>
            <input id="loginPin" type="password" maxlength="4" placeholder="****">
            <button class="btn-primary" onclick="handleLogin()">Unlock Dashboard</button>
            <button class="btn-ghost" onclick="navigateTo('signupPage')">New Merchant Sign-up</button>
        </div>
    </div>
</div>

<div id="dashboardPage" class="page">
    <div class="container">
        <header style="display:flex; justify-content:space-between; align-items:center; padding: 20px 0;">
            <div>
                <h1>LIPA <span style="color:var(--accent)">SME</span></h1>
                <p class="tagline">Global African Settlement</p>
            </div>
            <button class="btn-logout" onclick="logout()">Log Out</button>
        </header>

        <div class="card" style="text-align: center; border-bottom: 3px solid var(--accent);">
            <div class="profile-img">üè¢</div>
            <h2 id="merchantTitle">Merchant Name</h2>
            <p style="color:var(--muted); font-size: 0.8rem;" id="walletInfo">Syncing...</p>
        </div>

        <div class="card">
            <div class="card-title">üí∞ Liquid Cash <span onclick="toggleBalances()" style="cursor:pointer">üëÅ</span></div>
            <div class="bal-row">
                <div class="bal-item">
                    <label>FIAT (KES)</label>
                    <div class="bal-val" id="fiatBal">0.00</div>
                </div>
                <div class="bal-item">
                    <label>CRYPTO (USDT)</label>
                    <div class="bal-sub" id="cryptoBal">0.00</div>
                </div>
            </div>
        </div>

        <div class="card" style="border-color:var(--vault-color);">
            <div class="card-title" style="color:var(--vault-color)">üîí Locked Savings</div>
            <div style="text-align:center;padding:10px 0;">
                <div style="font-size:2.2rem;font-weight:800;color:var(--vault-color);" id="vaultBal">KES 0.00</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-title">‚ö° Point of Sale</div>
                <label>Amount (KES)</label>
                <input id="termAmt" type="number" value="100">
                <label>Phone Number</label>
                <input id="termPhone" type="text" placeholder="2547XXXXXXXX">
                <button class="btn-primary" onclick="initiatePayment()">Push M-Pesa Request</button>
            </div>
            <div class="card">
                <div class="card-title">üìã Direct Ledger</div>
                <div id="ledger"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="payModal">
    <div class="modal-inner" style="text-align:center;">
        <h2 style="color:var(--accent)">STK PUSH SENT</h2>
        <p id="pDesc" style="margin:20px 0;"></p>
        <button class="btn-primary" onclick="confirmPayment()">Verify Success</button>
        <button class="btn-ghost" onclick="closeModals()">Cancel</button>
    </div>
</div>

<script>
// AUTO-DETECT BASE URL
const BASE_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" 
    ? "http://localhost:10000" 
    : "";

let state = {
    user: null,
    tx: []
};

// --- AUTH HANDLERS ---
async function handleSignup() {
    const payload = {
        name: document.getElementById('regName').value,
        wallet: document.getElementById('regWallet').value,
        email: document.getElementById('regEmail').value,
        pin: document.getElementById('regPin').value
    };
    try {
        const res = await fetch(`${BASE_URL}/api/signup`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.success) {
            alert("Account Created! Please Login.");
            navigateTo('loginPage');
        } else {
            alert(data.error);
        }
    } catch(e) {
        alert("Server connection failed. Check if Backend is live on Render.");
    }
}

async function handleLogin() {
    const payload = {
        email: document.getElementById('loginEmail').value,
        pin: document.getElementById('loginPin').value
    };
    try {
        const res = await fetch(`${BASE_URL}/api/login`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.success) {
            state.user = data.merchant;
            navigateTo('dashboardPage');
        } else {
            alert(data.error);
        }
    } catch(e) {
        alert("Authentication failed. Ensure your MongoDB URI is correct.");
    }
}

// --- PAYMENT HANDLERS ---
async function initiatePayment() {
    const amt = document.getElementById('termAmt').value;
    const phone = document.getElementById('termPhone').value;
    
    if(!phone) return alert("Enter customer phone");

    try {
        const res = await fetch(`${BASE_URL}/api/stkpush`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ phone, amount: amt, email: state.user.email })
        });
        const data = await res.json();
        if(data.success) {
            document.getElementById('pDesc').innerText = `Checking for KES ${amt} on ${phone}...`;
            openModal('payModal');
            state.pendingAmt = amt;
        }
    } catch(e) {
        alert("Payment gateway unreachable.");
    }
}

async function confirmPayment() {
    // In production, this would verify the actual M-Pesa transaction via backend
    try {
        const res = await fetch(`${BASE_URL}/api/payment`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ email: state.user.email, amount: state.pendingAmt })
        });
        const data = await res.json();
        if(data.success) {
            state.user.fiatBalance = data.newBalance;
            state.tx.unshift({type: "M-Pesa IN", time: new Date().toLocaleTimeString(), amt: state.pendingAmt});
            closeModals();
            updateUI();
        }
    } catch(e) {
        alert("Sync failed.");
    }
}

// --- UI UTILS ---
function updateUI() {
    if(!state.user) return;
    document.getElementById('merchantTitle').innerText = state.user.name;
    document.getElementById('walletInfo').innerText = `Wallet: ${state.user.wallet}`;
    document.getElementById('fiatBal').innerText = state.user.fiatBalance.toLocaleString();
    document.getElementById('cryptoBal').innerText = state.user.cryptoBalance + " USDT";
    document.getElementById('vaultBal').innerText = "KES " + state.user.vaultBalance.toLocaleString();

    document.getElementById('ledger').innerHTML = state.tx.map(t => `
        <div class="tx-item">
            <div><strong>${t.type}</strong><br><small>${t.time}</small></div>
            <div style="color:var(--accent)">+${parseFloat(t.amt).toLocaleString()}</div>
        </div>`).join('');
}

function navigateTo(p) {
    document.querySelectorAll('.page').forEach(x => x.classList.remove('active-page'));
    document.getElementById(p).classList.add('active-page');
    if(p === 'dashboardPage') updateUI();
}

function logout() { state.user = null; navigateTo('loginPage'); }
function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
</script>
</body>
</html>
